# Environment settings

(work in progress)

The variables written and loaded using the scripts in this directory are used in all CWT tasks. Some are common to any type of stack, while others are specific to certain variants.

The very first step required to use CWT is writing env settings (**stack init**) :

```sh
# This is the starting point.
# It provides options and/or terminal prompts to obtain all mandatory values.
. cwt/stack/init.sh

# cwt/stack/init.sh then calls :
# . cwt/env/write.sh
```

In order to conditionally generate the correct variables for the current project stack (host-level dependencies, build/test tools, service-specific configuration...), the following rules are used :

## Start with common CWT variables (target : host-level deps)

Loaded from `cwt/env/dist/env.vars.sh`, contains the fundamental value `$PROJECT_STACK` used to derive the rest of conditional settings. Examples :

- `contenta` (nothing else specified = use latest version on a corresponding "barebone", minimal stack)
- `drupal-7--php-5.4,redis,solr-3` (request additional services after the *variant* or *modifier* separator : `--` and then separate multiple services by `,` if needed)
- `phenomic--preset-1` (predefined "combos" may be provided as *presets*)

TODO explain agregation + customization (rewrite below)

## Conventions

To support variants using the same scripts, CWT relies on conventions.

The (over)writing happens during **stack init** phase. It copies files from the `cwt/env/dist` dir into `cwt/env/current`, while replacing their placeholders with the values generated by the stack init script (`cwt/stack/init.sh`).

Some settings may be applicable only for some type of project stack, provision method, or any combination of stack init script arguments. Conditional generation of corresponding env settings uses naming convention and folder structure, as described in the example below.

Given the following value for the '-s' or '--stack' arg: "drupal-7", and for the '-p' or '--provision' arg: "scripts", this script will attempt to copy the contents of all the following files (if they exist), append it to the file storing settings of the current local instance, `cwt/env/current/.app.vars.sh` :

- `cwt/env/dist/drupal/app.vars.sh.dist`
- `cwt/env/dist/drupal/scripts.provision.vars.sh.dist`
- `cwt/env/dist/drupal/7/app.vars.sh.dist`
- `cwt/env/dist/drupal/7/scripts.provision.vars.sh.dist`

Then it proceeds to replace all placeholders from the dist files with values from variables populated in stack init, using the following convention :

`__replace_this_DB_NAME_value__` -> `$P_DB_NAME`

The naming convention for variables "assembled" in `cwt/stack/init.sh` is the prefix "P_" + the actual env var name, as they will be loaded by `cwt/env/load.sh`.

## [wip] TODO

Implement a generic set of variants (covering usual local and/or remote setups) using the following variables :

```sh
# Add deploying methods :
DEPLOY_USING=git
DEPLOY_USING=ansistrano

# To implement "base" stack variants :
PROJECT_STACK=drupal7_lamp
PROJECT_STACK=drupal8_docker_compose

# To support different provisionning implementations :
PROVISION=scripts # default (alternative : make optional - assume when undefined or empty)
PROVISION=ansible

# To use other local "registry" implementations :
REG_BACKEND=file # default (alternative : make optional - assume when undefined or empty)
REG_BACKEND=ansible_vault
REG_BACKEND=hashicorp_vault

# To specify automated tests (presets ?) :
APP_TESTS_PRESET=behat
APP_TESTS_PRESET=gatling

# Visual regression testing (presets ?) :
APP_VRT_PRESET=gemini
APP_VRT_PRESET=puppeteer
```
